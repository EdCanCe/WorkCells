<div class="content p-6">
    <div class="card bg-white p-6 rounded-lg shadow-md">
        <div class="card-content">
            <h2 class="text-2xl font-semibold mb-4">Absences request</h2>

            <div class="overflow-x-auto">
                <table class="min-w-full table-auto" id="absences-table">
                    <thead>
                        <tr class="bg-gray-100">
                            <th
                                class="px-4 py-2 text-center font-semibold text-gray-700"
                            >
                                <abbr title="nombre">Full name</abbr>
                            </th>
                            <th
                                class="px-4 py-2 text-center font-semibold text-gray-700"
                            >
                                <abbr title="rol">Role</abbr>
                            </th>
                            <th
                                class="px-4 py-2 text-center font-semibold text-gray-700"
                            >
                                <abbr title="fecha inicio">Start date</abbr>
                            </th>
                            <th
                                class="px-4 py-2 text-center font-semibold text-gray-700"
                            >
                                <abbr title="fecha fin">End date</abbr>
                            </th>
                            <th
                                class="px-4 py-2 text-center font-semibold text-gray-700"
                            >
                                <abbr title="dias totales">Total days</abbr>
                            </th>
                            <th
                                class="px-4 py-2 text-center font-semibold text-gray-700"
                            >
                                <abbr title="razon">Reason</abbr>
                            </th>
                            <th
                                class="px-4 py-2 text-center font-semibold text-gray-700"
                                >
                                <abbr title="estado">Status</abbr>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for (let ab of absences) { %>
                        <tr class="bg-gray-100">
                            <th
                                class="px-4 py-2 text-center font-semibold text-gray-700"
                            >
                                <%- ab.birthName + ' ' + ab.surname %>
                            </th>
                            <th
                                class="px-4 py-2 text-center font-semibold text-gray-700"
                            >
                                <%- ab.title %>
                            </th>
                            <th
                                class="px-4 py-2 text-center font-semibold text-gray-700"
                            >
                                <%= new
                                Date(ab.startDate).toLocaleDateString('es-MX');
                                %>
                            </th>
                            <th
                                class="px-4 py-2 text-center font-semibold text-gray-700"
                            >
                                <%= new
                                Date(ab.endDate).toLocaleDateString('es-MX'); %>
                            </th>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 total-days"
                                data-start-date="<%= ab.startDate %>"
                                data-end-date="<%= ab.endDate %>"
                            ></td>
                            <th>
                                <%- ab.reason %>
                            </th>
                            <th
                                class="px-4 py-2 text-center font-semibold text-gray-700"
                            >
                                <% if (ab.justified === 0) { %>
                                    <span class="text-red-600 font-semibold">Denied</span>
                                <% } else
                                if (ab.justified === 1) { %>
                                    <span class="text-green-600 font-semibold">Approved</span>
                                <% } else
                                if (ab.justified === 2) { %>
                                <div class="px-6 py-4 flex justify-end">
                                    <button
                                        class="approve-btn bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 mr-2 rounded"
                                        data-url="/absence/requests/approve/<%- ab.absenceID %>"
                                        data-csrf="<%= csrfToken %>"
                                    >
                                        Approve
                                    </button>
                                    <br />
                                    <button
                                        class="deny-btn bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 mr-2 rounded"
                                        data-url="/absence/requests/deny/<%- ab.absenceID %>"
                                        data-csrf="<%= csrfToken %>"
                                    >
                                        Denied
                                    </button>
                                </div>
                                <% } %>
                            </th>
                        </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-4 flex justify-center space-x-4">
            <a
                href="/absence"
                class="button bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600"
                >Regresar</a
            >
        </div>
    </div>
</div>

<script>
    // Calcular los días para cada fila una vez que la página se ha cargado
    document.addEventListener("DOMContentLoaded", function () {
        const rows = document.querySelectorAll("#absences-table tbody tr");
        rows.forEach((row) => {
            const startDate = new Date(
                row.querySelector(".total-days").getAttribute("data-start-date")
            );
            const endDate = new Date(
                row.querySelector(".total-days").getAttribute("data-end-date")
            );
            const timeDifference = endDate - startDate;
            const totalDays = timeDifference / (1000 * 3600 * 24);

            // Asignar el total de días a la celda correspondiente
            row.querySelector(".total-days").innerText = totalDays;
        });
    });

    // Agregar event listener a todos los botones de "Approve"
    document.querySelectorAll(".approve-btn").forEach((button) => {
        button.addEventListener("click", async function (event) {
            const url = this.dataset.url;
            const csrf = this.dataset.csrf;
            
            // Deshabilitar el botón y mostrar estado de carga
            this.disabled = true;
            const originalText = this.innerText;
            this.innerText = "Processing...";

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "csrf-token": csrf,
                    },
                    body: JSON.stringify({}),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Obtener la celda de la tabla que contiene los botones
                const tableCell = this.closest('th');
                // Reemplazar el contenido con el nuevo estado
                tableCell.innerHTML = '<span class="text-green-600 font-semibold">Approved</span>';
            } catch (err) {
                console.error("Error al aprobar:", err);
                // Restaurar el estado del botón en caso de error
                this.disabled = false;
                this.innerText = originalText;
                alert("Hubo un error al procesar la solicitud. Por favor, intente nuevamente.");
            }
        });
    });

    // Agregar event listener a todos los botones de "Deny"
    document.querySelectorAll(".deny-btn").forEach((button) => {
        button.addEventListener("click", async function (event) {
            const url = this.dataset.url;
            const csrf = this.dataset.csrf;
            
            // Deshabilitar el botón y mostrar estado de carga
            this.disabled = true;
            const originalText = this.innerText;
            this.innerText = "Processing...";

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "csrf-token": csrf,
                    },
                    body: JSON.stringify({}),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Obtener la celda de la tabla que contiene los botones
                const tableCell = this.closest('th');
                // Reemplazar el contenido con el nuevo estado
                tableCell.innerHTML = '<span class="text-red-600 font-semibold">Denied</span>';
            } catch (err) {
                console.error("Error denying:", err);
                // Restaurar el estado del botón en caso de error
                this.disabled = false;
                this.innerText = originalText;
                alert("Hubo un error al procesar la solicitud. Por favor, intente nuevamente.");
            }
        });
    });
</script>